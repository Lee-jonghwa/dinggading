# ğŸ“¦ í”„ë¡œì íŠ¸ ë¹Œë“œ & ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìš”ì•½
- ëª¨ë“  ëª…ë ¹ì€ í”„ë¡œì íŠ¸ì˜ ë£¨íŠ¸ í´ë”ì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼í•©ë‹ˆë‹¤.

## ğŸ§© ê³µí†µ í™˜ê²½ ë³€ìˆ˜

| ë³€ìˆ˜ëª… | ì„¤ëª… |
|--------|------|
| `DOCKER_HUB_USERNAME`, `DOCKER_HUB_PASSWORD` | Docker Hub ì¸ì¦ ì •ë³´ |
| `PROJECT_NAME` | í”„ë¡œì íŠ¸ ì´ë¦„ ex) `s12p21e107` |
| `SERVER_HOST`, `SSH_PRIVATE_KEY`, `PEM_FILE` | SSH ì ‘ì† ê´€ë ¨ ë°°í¬ ì •ë³´ |
| `NEXT_PUBLIC_API_BASE_URL`, `NEXT_PUBLIC_ENV_MODE` | í”„ë¡ íŠ¸ì—”ë“œ í™˜ê²½ ë³€ìˆ˜ |

## ì„œë²„ íŒŒì¼ êµ¬ì¡°
```
.
â”œâ”€â”€ docker-compose.prod.yaml
â”œâ”€â”€ infra
â”‚Â Â  â””â”€â”€ env
â””â”€â”€ nginx
    â”œâ”€â”€ conf
    â”‚Â Â  â”œâ”€â”€ nginx.conf
    â”‚Â Â  
    â”œâ”€â”€ docker-compose.yaml
    â””â”€â”€ init-letsencrypt.sh

```


---

## ğŸ› ï¸ 1. ë°±ì—”ë“œ(Spring)


### ğŸ—ï¸ ë¹Œë“œ & í‘¸ì‹œ
```bash
docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD

docker buildx build \
  -t ${DOCKER_HUB_USERNAME}/${PROJECT_NAME}-spring:latest \
  --target production \
  -f ./infra/dockerfiles/backend.Dockerfile \
  --build-arg PLATFORM=linux/amd64 \
  --platform linux/amd64 .

docker push ${DOCKER_HUB_USERNAME}/${PROJECT_NAME}-spring:latest
```

---

## ğŸ–¥ï¸ 2. í”„ë¡ íŠ¸ì—”ë“œ(Next.js)

### ğŸ—ï¸ ë¹Œë“œ & í‘¸ì‹œ
```bash
docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD

docker buildx build \
  -t ${DOCKER_HUB_USERNAME}/${PROJECT_NAME}-next:latest \
  --target production \
  -f ./infra/dockerfiles/frontend.Dockerfile \
  --build-arg PLATFORM=linux/amd64 \
  --build-arg NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL} \
  --build-arg NEXT_PUBLIC_ENV_MODE=${NEXT_PUBLIC_ENV_MODE} \
  --platform linux/amd64 .

docker push ${DOCKER_HUB_USERNAME}/${PROJECT_NAME}-next:latest
```

---

## ğŸ¤– 3. AI (FastAPI + Celery Worker)

> ë‘ êµ¬ì„± ëª¨ë‘ ê°™ì€ Dockerfileì„ ì‚¬ìš©í•˜ì§€ë§Œ `STAGE`ë¡œ êµ¬ë¶„ë¨

### ğŸ—ï¸ FastAPI ë¹Œë“œ & í‘¸ì‹œ
```bash
docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD

docker buildx build \
  -t ${DOCKER_HUB_USERNAME}/${PROJECT_NAME}-fastapi:latest \
  --target production \
  -f ./infra/dockerfiles/ai.Dockerfile \
  --build-arg PLATFORM=linux/amd64 \
  --build-arg STAGE=production \
  --platform linux/amd64 .

docker push ${DOCKER_HUB_USERNAME}/${PROJECT_NAME}-fastapi:latest
```

### ğŸ—ï¸ Celery Worker ë¹Œë“œ & í‘¸ì‹œ
```bash
docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD

docker buildx build \
  -t ${DOCKER_HUB_USERNAME}/${PROJECT_NAME}-celery:latest \
  --target production \
  -f ./infra/dockerfiles/ai.Dockerfile \
  --build-arg PLATFORM=linux/amd64 \
  --build-arg STAGE=production \
  --platform linux/amd64 .

docker push ${DOCKER_HUB_USERNAME}/${PROJECT_NAME}-celery:latest
```

---

## ğŸš€ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ (ì„œë²„)

```bash
# SSH ì„¤ì • ë° Docker Compose ì‹¤í–‰
apk add --no-cache openssh-client bash
eval $(ssh-agent -s)
echo "$SSH_PRIVATE_KEY" > $PEM_FILE
chmod 400 $PEM_FILE
mkdir -p ~/.ssh
chmod 700 ~/.ssh
ssh-keyscan $SERVER_HOST >> ~/.ssh/known_hosts
chmod 644 ~/.ssh/known_hosts

# ì„œë²„ ì ‘ì† ë° ì„¤ì •
ssh -i $PEM_FILE ubuntu@$SERVER_HOST "mkdir -p /home/ubuntu/${PROJECT_NAME}/infra/env"

# docker-compose ë°°í¬
scp -i $PEM_FILE docker-compose.prod.yaml ubuntu@$SERVER_HOST:/home/ubuntu/${PROJECT_NAME}/

ssh -i $PEM_FILE ubuntu@$SERVER_HOST "
  cd /home/ubuntu/${PROJECT_NAME} &&
  echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USERNAME --password-stdin &&
  docker pull $DOCKER_HUB_USERNAME/${PROJECT_NAME}-spring:latest &&
  docker pull $DOCKER_HUB_USERNAME/${PROJECT_NAME}-next:latest &&
  docker pull $DOCKER_HUB_USERNAME/${PROJECT_NAME}-fastapi:latest &&
  docker pull $DOCKER_HUB_USERNAME/${PROJECT_NAME}-celery:latest &&
  docker-compose -f docker-compose.prod.yaml down &&
  docker-compose -f docker-compose.prod.yaml up -d &&
  docker-compose -f ./nginx/docker-compose.yaml down &&
  docker-compose -f ./nginx/docker-compose.yaml up -d"
```

## ğŸ—ï¸ nginx ì„¤ì •
ë‹¤ë¥¸ ì„œë¹„ìŠ¤ê°€ ê°™ì€ ë„ì»¤ ë„¤íŠ¸ì›Œí¬ì— ì¡´ì¬í•´ì•¼í•©ë‹ˆë‹¤!

```
events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name j12e107.p.ssafy.io;
        server_tokens off;

        # HTTPë¥¼ ìë™ìœ¼ë¡œ HTTPSë¡œ ì´ë™í•˜ê²Œí•´ì£¼ëŠ” í—¤ë”
        add_header Strict-Transport-Security "max-age=0";

        # OAuth ê´€ë ¨ ëª¨ë“  ê²½ë¡œë¥¼ ìŠ¤í”„ë§ ì„œë²„ë¡œ ì „ë‹¬
        location /oauth2/ {
            proxy_pass http://spring:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # OAuth ì½œë°± URLë„ ìŠ¤í”„ë§ìœ¼ë¡œ ì „ë‹¬
        location /login/oauth2/ {
            proxy_pass http://spring:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            # return 301 https://$host$request_uri;
            proxy_pass http://next:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

    }

    server {
        listen 443 ssl;
        server_name j12e107.p.ssafy.io;
        server_tokens off;

        ssl_certificate /etc/letsencrypt/live/j12e107.p.ssafy.io/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/j12e107.p.ssafy.io/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        add_header Strict-Transport-Security "max-age=0";

                # OAuth ê´€ë ¨ ëª¨ë“  ê²½ë¡œë¥¼ ìŠ¤í”„ë§ ì„œë²„ë¡œ ì „ë‹¬
        location /login/oauth2/ {
            proxy_pass http://spring:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /oauth2/ {
            proxy_pass http://spring:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        }

        # OAuth ì½œë°± URLë„ ìŠ¤í”„ë§ìœ¼ë¡œ ì „ë‹¬
        location /login {
            proxy_pass http://next:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location / {
            proxy_pass  http://next:3000;
            proxy_set_header    Host                $http_host;
            proxy_set_header    X-Real-IP           $remote_addr;
            proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
        }
    }
    server {
        listen 19000;
        server_name j12e107.p.ssafy.io;
        server_tokens off;

        add_header Strict-Transport-Security "max-age=0";
        location / {
            proxy_pass http://j12e107.p.ssafy.io:19000;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
    # 8081 í¬íŠ¸ë¥¼ ìœ„í•œ ì„œë²„ ë¸”ë¡ (HTTP)
    server {
        listen 8081;
        server_name j12e107.p.ssafy.io;
        server_tokens off;

        add_header Strict-Transport-Security "max-age=0";
        location / {
            proxy_pass http://j12e107.p.ssafy.io:8081;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
    # 8443 í¬íŠ¸ë¥¼ ìœ„í•œ ì„œë²„ ë¸”ë¡ (HTTPS)
    server {
        listen 8443;
        server_name j12e107.p.ssafy.io;

        add_header Strict-Transport-Security "max-age=0";

        location / {
            proxy_pass http://j12e107.p.ssafy.io:8443;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
```

### docker-compose íŒŒì¼
docker-compose.prod.yamlì´ ì‹¤í–‰ëœ ìƒíƒœì—ì„œ ì‹¤í–‰í•´ì•¼í•©ë‹ˆë‹¤.

```bash

# ì‹¤í–‰ ëª…ë ¹ì–´
docker-compose up -d
```

```
version: '3'
services:
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    volumes:
      - ./conf/nginx.conf:/etc/nginx/nginx.conf
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    ports:
      - 80:80
      - 443:443
    networks:
      - ding-ga-ding-network
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
  certbot:
    image: certbot/certbot
    restart: unless-stopped
    volumes:
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - ding-ga-ding-network
networks:
  ding-ga-ding-network:
    external: true
```




## ğŸ§¾ ì°¸ê³  ì‚¬í•­
- Dockerfile ê²½ë¡œ: `./infra/dockerfiles/`
- `buildx` ì‚¬ìš© ì‹œ `--platform`, `--target`, `--build-arg` ì£¼ì˜
- AI ë¶€ë¶„ì€ FastAPIì™€ Celeryë¥¼ ë¶„ë¦¬ ë°°í¬í•˜ì§€ë§Œ Dockerfileì€ ê³µìœ 

